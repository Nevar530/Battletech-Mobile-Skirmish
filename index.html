2<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>B^TTLETECH | MOBILE SKIRMISH</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://sheets.flechs.net" />

  <!-- ==== Firebase init (default app + Firestore, exposed globally) ==== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore }   from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Use EXACTLY the values from your Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyDOh34aMfltGvEHzI-weStxmmh8amTSgZw",
      authDomain: "battletech-mobile-skirmish.firebaseapp.com",
      projectId: "battletech-mobile-skirmish",
      storageBucket: "battletech-mobile-skirmish.appspot.com",
      messagingSenderId: "630400031231",
      appId: "1:630400031231:web:bceb3b9392d15b1b866fca",
      measurementId: "G-M48HZ3ZEV9"
    };

    const app = initializeApp(firebaseConfig);
    // Optional exposure if needed elsewhere
    window.db = getFirestore(app);
    window.FIREBASE_CONFIG = firebaseConfig;
  </script>
  <!-- ==== /Firebase ==== -->
</head>
<body>
  <div id="wrap" class="wrap">

    <!-- ===== BattleTech Boot Overlay ===== -->
    <div id="btBoot">
      <div class="bt-vignette"></div>
      <div class="bt-scanlines"></div>
      <div class="bt-content">
        <h1 class="bt-title">B^TTLETECH | MOBILE SKIRMISH</h1>
        <div class="bt-sub">MECH POWER-UP SEQUENCE • INNER SPHERE COMSAT UPLINK</div>
        <pre id="btLog" class="bt-log" aria-live="polite"></pre>
        <div class="bt-progress"><div class="bt-bar" id="btBar"></div></div>
        <div class="bt-hint" id="btHint">PRESS ENTER TO DEPLOY • AUTO WHEN READY</div>
      </div>
    </div>

    <!-- ===== Top bar ===== -->
    <header class="ui-topbar" role="banner">
      <div class="brand"><span class="bt">B^TTLETECH</span><span class="sep">//</span>MOBILE SKIRMISH</div>
      <div class="spacer"></div>

      <!-- Undo / Redo -->
      <button id="btnUndo" class="icon-btn" title="Undo (Ctrl+Z)" aria-label="Undo">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M7 7V3L1 9l6 6v-4h6a5 5 0 110 10h-2v-2h2a3 3 0 100-6H7z" fill="currentColor"/></svg>
      </button>
      <button id="btnRedo" class="icon-btn" title="Redo (Ctrl+Y)" aria-label="Redo">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M17 7V3l6 6-6 6v-4h-6a5 5 0 100 10h2v-2h-2a3 3 0 110-6h6z" fill="currentColor"/></svg>
      </button>

      <!-- Zoom Out / Zoom In -->
      <button id="btnZoomOut" class="icon-btn" title="Zoom Out (Wheel/−)">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
          <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1015.5 14l4.5 4.5-1.5 1.5L14 15.5zm-5 0A4.5 4.5 0 1115 9.5 4.5 4.5 0 0110.5 14z" fill="currentColor"/>
          <rect x="8" y="9.25" width="5" height="1.5" rx=".75" fill="currentColor"/>
        </svg>
      </button>
      <button id="btnZoomIn" class="icon-btn" title="Zoom In (Wheel/+)">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
          <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1015.5 14l4.5 4.5-1.5 1.5L14 15.5zm-5 0A4.5 4.5 0 1115 9.5 4.5 4.5 0 0110.5 14z" fill="currentColor"/>
          <path d="M11.25 8v1.25H10v1.5h1.25V12h1.5v-1.25H14v-1.5h-1.25V8z" fill="currentColor"/>
        </svg>
      </button>

      <!-- Recenter -->
      <button id="btnRecenter" class="icon-btn" title="Recenter (0)">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true">
          <path d="M11 2v2.1A8 8 0 004.1 11H2v2h2.1A8 8 0 0011 19.9V22h2v-2.1A8 8 0 0019.9 13H22v-2h-2.1A8 8 0 0013 4.1V2h-2zm1 5a5 5 0 110 10 5 5 0 010-10z" fill="currentColor"/>
        </svg>
      </button>

      <!-- Fullscreen -->
      <button id="fsBtn" class="icon-btn" title="Fullscreen (F)">⛶</button>

      <!-- Save / Load -->
      <button id="exportJson" class="icon-btn" title="Save JSON (Export)">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M5 20h14v-2H5v2zm7-18l5 5h-3v6h-4V7H7l5-5z" fill="currentColor"/></svg>
      </button>
      <button id="importJsonBtn" class="icon-btn" title="Load JSON (Import)">
        <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M19 13v6H5v-6H3v8h18v-8h-2zM11 3v8H8l4 4 4-4h-3V3h-2z" fill="currentColor"/></svg>
      </button>

      <!-- Segmented: Terrain / Mechs -->
      <div class="seg-group">
        <div class="seg-item">
          <span class="seg-label">Terrain</span>
          <button id="toggleLeft" class="icon-btn seg-btn" title="Terrain Tools" aria-pressed="false">
            <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M3 19h18l-6-9-3 4-2-3-7 8zM15 5l3 4 3-4" fill="currentColor"/></svg>
          </button>
        </div>
        <div class="seg-item">
          <span class="seg-label">Mechs</span>
          <button id="toggleRight" class="icon-btn seg-btn" title="Mechs & Utilities" aria-pressed="false">
            <svg viewBox="0 0 24 24" class="ico" aria-hidden="true"><path d="M7 20h10v-2c0-2.8-2.2-5-5-5H8l1.2-2.4C9.7 9.8 11 9 12.4 9H14L12 6 9 7 7 4 5 5l2 4-3 5v6z" fill="currentColor"/></svg>
          </button>
        </div>
      </div>

      <!-- Flechs Sheets dock toggles -->
      <div class="flechs-top row gap" style="align-items:center;">
        <img src="https://sheets.flechs.net/img/favicon-32x32.png" alt="Flechs" class="flechs-ico" width="18" height="18" />
        <span class="small muted">Flechs Sheets</span>
        <button id="btnDockL" class="icon-btn" title="Toggle Flechs Dock (P1)">P1</button>
        <button id="btnDockR" class="icon-btn" title="Toggle Flechs Dock (P2)">P2</button>
      </div>

      <!-- Online play -->
      <button id="btn-online" class="icon-btn" title="Online play">Online</button>
      <button id="btnSend" class="icon-btn" title="Send state to peer">Send</button>
    </header>

    <!-- ===== LEFT / RIGHT PANELS, HELP, STAGE ===== -->
    <!-- (unchanged content from your file) -->

    <main class="stage">
      <div id="dockA" class="dock dock-left" aria-label="Flechs Sheets (P1)">
        <header>
          <strong>P1</strong><span class="spacer"></span>
          <button id="homeA">Home</button>
          <button id="openA">Open</button>
          <button id="closeA">✕</button>
        </header>
        <div class="hint">If this stays blank, your browser blocked embedding. Click “Open”.</div>
        <iframe id="frameA" title="Flechs Sheets (P1)"></iframe>
      </div>

      <div id="dockB" class="dock dock-right" aria-label="Flechs Sheets (P2)">
        <header>
          <strong>P2</strong><span class="spacer"></span>
          <button id="homeB">Home</button>
          <button id="openB">Open</button>
          <button id="closeB">✕</button>
        </header>
        <div class="hint">If this stays blank, your browser blocked embedding. Click “Open”.</div>
        <iframe id="frameB" title="Flechs Sheets (P2)"></iframe>
      </div>

      <svg id="svg" tabindex="0" xmlns="http://www.w3.org/2000/svg" aria-label="Hex map">
        <defs id="tex-defs"></defs>
        <rect id="frameBorder" class="gridBorder"></rect>
        <g id="world-polys"></g>
        <g id="world-textures"></g>
        <g id="world-shadows"></g>
        <g id="world-overlays"></g>
        <g id="world-labels"></g>
        <g id="world-tokens"></g>
        <g id="measure-group"></g>
        <g id="los-rays"></g>
        <g id="los-group"></g>
      </svg>

      <div id="tokenControls" style="display:none; position:absolute; z-index:50; pointer-events:none;">
        <button id="btnTurnLeft"  style="pointer-events:auto; margin-right:4px;">⟲</button>
        <button id="btnTurnRight" style="pointer-events:auto;">⟳</button>
      </div>
    </main>

    <textarea id="io" rows="8" style="display:none" aria-hidden="true"></textarea>
  </div>

 <!-- Your game first (so it can boot even if networking is slow) -->
<script src="script.js"></script>

<!-- Networking next -->
<script type="module" src="network.js"></script>

<!-- Tiny join flow for the Online button -->
<script>
  (function () {
    const btn = document.getElementById('btn-online');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      try {
        if (!window.Net || typeof Net.joinRoom !== 'function') {
          alert('Networking not ready yet. Try again in a moment.');
          return;
        }
        const code = prompt('Enter 3 words (e.g., "ember orbit fox")');
        if (!code) return;
        const room = await Net.joinRoom(code, { maxPlayers: 2 });
        alert('Joined room: ' + room);
      } catch (e) {
        alert(e?.message || 'Failed to join room');
      }
    });
  })();
</script>
</body>
</html>